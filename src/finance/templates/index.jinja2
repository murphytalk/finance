{% extends "layout.jinja2" %}

{% block content %}

    <div class="row">
        <div class="col-md-8">
            <h2 class="text-center">Wealth Allocations</h2>
            <ul id="tab1" class="nav nav-tabs">
                <li class="active"><a data-toggle="tab" href="#asset">Asset</a></li>
                <li><a data-toggle="tab" href="#region">Region</a></li>
                <li><a data-toggle="tab" href="#country">Country</a></li>
            </ul>
            <div class="tab-content">
                <div id="asset" class="tab-pane fade">
                    <div id="pieAsset" class="text-center"></div>
                </div>
                <div id="region" class="tab-pane fade">
                    <div id="pieRegion">></div>
                </div>
                <div id="country" class="tab-pane fade">
                    <div id="pieCountry">></div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="row">
                <h3 class="text-center">Overview</h3>
            </div>
            <div class="row">
                <table class="table table-hover" id="overview">
                    <thead>
                    <tr>
                        <th rowspan="2" class="text-left`">Type</th>
                        <th rowspan="2" class="text-right">CCY</th>
                        <th colspan="2" class="text-right">Market Value</th>
                        <th colspan="1" class="text-right">Profit</th>
                    </tr>
                    <tr>
                        <th class="text-right">CCY</th>
                        <th class="text-right">JPY</th>
                        <th class="text-right">JPY</th>
                    </tr>
                    </thead>
                    <tfoot>
                    <tr>
                        <th></th>
                        <th></th>
                        <th class="text-right">
                            <div id="value_ccy"></div>
                        </th>
                        <th class="text-right">
                            <div id="value_jpy"></div>
                        </th>
                        <th class="text-right">
                            <div id="profit"></div>
                        </th>
                    </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <h2 class="text-center">Instrument Allocations</h2>
            <ul id="tab2" class="nav nav-tabs">
                <li class="active"><a data-toggle="tab" href="#stock">Stock/ETF</a></li>
                <li><a data-toggle="tab" href="#fund">Mutual Funds</a></li>
            </ul>
            <div class="tab-content">
                <div id="stock" class="tab-pane fade">
                    <div id="pieStock"></div>
                </div>
                <div id="fund" class="tab-pane fade">
                    <div id="pieFund"></div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="row">
                <div class="dropdown left5">
                    <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Instrument
                        Filters
                        <span class="caret"></span></button>
                    <ul class="dropdown-menu">
                        <li><a href="#">HTML</a></li>
                        <li><a href="#">CSS</a></li>
                        <li><a href="#">JavaScript</a></li>
                    </ul>
                </div>
            </div>
            <div class="row">
                <table class="table table-hover" id="overview">
                    <thead>
                    <tr>
                        <th class="text-right">Type</th>
                        <th class="text-right">Instrument</th>
                    </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="/static/finance/scripts/chart.js"></script>
    <script>
        function to_chart_data(data) {
            return {'y': data['JPY'], 'name': data['symbol']};
        }
        $(document).ready(function () {
            $.getJSON("{{ url_for('finance_page.sum_json')}}",
                function (data) {
                    $('#pieCountry').highcharts(pieChartOptions(null, 'Market Value', data['country'], false));
                    $('#pieRegion').highcharts(pieChartOptions(null, 'Market Value', data['region'], false));
                    $('#pieAsset').highcharts(pieChartOptions(null, 'Market Value', data['asset'], false));

                    var stocks = [];
                    $.each(data['stock'], function (i, v) {
                        stocks.push(to_chart_data(v));
                    });
                    $.each(data['ETF'], function (i, v) {
                        stocks.push(to_chart_data(v));
                    });

                    $('#pieStock').highcharts(pieChartOptions(null, 'Market Value', stocks, false));

                    var funds = [];
                    $.each(data['funds'], function (i, v) {
                        funds.push(to_chart_data(v));
                    });
                    $('#pieFund').highcharts(pieChartOptions(null, 'Market Value', funds, false));
                    $('#totalValue').text(data['total'].toLocaleString());

                    //reflow chart when its host tab is shown, otherwise the chart won't position itself at center
                    $('.nav-tabs a').on('shown.bs.tab', function (event) {
                        var x = $(event.target).text();         // active tab
                        var chart_selector;
                        if (x == 'Asset') {
                            chart_selector = "#pieAsset";
                        }
                        else if (x == 'Region') {
                            chart_selector = "#pieRegion";
                        }
                        else if (x == 'Country') {
                            chart_selector = "#pieCountry";
                        }
                        else if (x == 'Stock/ETF') {
                            chart_selector = "#pieStock";
                        }
                        else {
                            chart_selector = "#pieFund";
                        }
                        var chart = $(chart_selector).highcharts();
                        chart.reflow();
                    });


                    //if any of the 2 show below is missing, the chart won't flow
                    $('.nav-tabs').tab("show");
                    $('#tab1 a[href="#asset"]').tab("show");
                    $('#tab2 a[href="#stock"]').tab("show");
                });

        });
    </script>
{% endblock %}
